# 下一步实施计划

**更新时间**: 2025-12-17
**当前状态**: Phase 2.7 已完成 ✅

---

## 📋 当前进度总览

### Phase 2 进度：7/10 完成 (70%)

| 阶段 | 状态 | 完成度 |
|------|------|--------|
| 2.1 Socket.IO 基础架构 | ✅ 完成 | 100% |
| 2.2 Node 客户端管理 | ✅ 完成 | 100% |
| 2.3 终端注册与缓存 | ✅ 完成 | 100% |
| 2.4 协议服务 | ✅ 完成 | 100% |
| 2.5 指令生成 | ✅ 完成 | 100% |
| 2.6 查询循环 | ✅ 完成 | 100% |
| 2.7 查询结果处理 | ✅ 完成 | 100% |
| 2.8 DTU 操作 | ⏳ 待实施 | 0% |
| 2.9 WebSocket 用户连接 | ⏳ 待实施 | 0% |
| 2.10 集成测试 | ⏳ 待实施 | 0% |

---

## 🎯 优先级 1：Phase 2.8 - DTU 操作

### 目标
实现 DTU 远程操作功能，支持重启、配置更新、透传指令等管理操作。

### 任务清单

#### 2.8.1 OprateDTU 事件实现
- [ ] 创建 DTU 操作类型定义
  ```typescript
  type DtuOperationType =
    | 'restart'           // 重启 DTU
    | 'restart485'        // 重启 485 总线
    | 'updateMount'       // 更新挂载配置
    | 'OprateInstruct'    // 透传指令
    | 'setTerminal'       // 设置终端参数
    | 'getTerminal';      // 获取终端信息
  ```

- [ ] 实现 `OprateDTU()` 方法（已存在，需验证）
  - 路由操作到正确的 Node 客户端
  - EventEmitter 模式的请求/响应
  - 10s 超时处理
  - 操作日志记录

#### 2.8.2 DTU 操作日志
- [ ] 创建 `log.dtuoperations` 集合
  ```typescript
  interface DtuOperationLog {
    mac: string;              // DTU MAC 地址
    operation: string;        // 操作类型
    content?: any;            // 操作内容
    success: boolean;         // 是否成功
    message?: string;         // 结果消息
    operatedBy: string;       // 操作人
    operatedAt: Date;         // 操作时间
    useTime: number;          // 耗时(ms)
  }
  ```

- [ ] 记录所有 DTU 操作到数据库
- [ ] 实现操作历史查询接口

#### 2.8.3 DTU 操作 API
- [ ] `POST /api/dtu/restart` - 重启 DTU
- [ ] `POST /api/dtu/restart485` - 重启 485 总线
- [ ] `POST /api/dtu/updateMount` - 更新挂载配置
- [ ] `POST /api/dtu/operate` - 通用操作接口
- [ ] 权限控制（需要管理员或设备拥有者）

#### 2.8.4 测试
- [ ] 单元测试：每种操作类型
- [ ] 集成测试：完整操作流程
- [ ] 超时测试：Node 不响应的情况
- [ ] 并发测试：多个操作同时进行

### 验收标准
- ✅ 所有 6 种操作类型正常工作
- ✅ 操作日志正确记录
- ✅ API 权限控制有效
- ✅ 超时和错误处理正确
- ✅ 单元测试覆盖率 > 80%

### 预计工时
- 开发：8-12 小时
- 测试：4-6 小时
- 总计：12-18 小时

---

## 🎯 优先级 2：Phase 2.9 - WebSocket 用户连接

### 目标
实现浏览器端 WebSocket 连接，支持用户订阅设备实时数据推送。

### 任务清单

#### 2.9.1 WebSocket 服务实现
- [ ] 创建 `SocketService` 类（基于 `ws` 库）
- [ ] WebSocket 连接管理
- [ ] JWT 认证中间件
- [ ] 心跳机制（30s ping/pong）
- [ ] 连接池管理

#### 2.9.2 用户房间管理
- [ ] 实现房间订阅机制
  ```typescript
  // 用户订阅设备
  socket.emit('subscribe', { mac: 'xxx', pid: 1 });

  // 用户取消订阅
  socket.emit('unsubscribe', { mac: 'xxx', pid: 1 });
  ```

- [ ] 房间成员管理（一个设备对应一个房间）
- [ ] 用户权限验证（只能订阅自己的设备）
- [ ] 订阅列表持久化（Redis）

#### 2.9.3 实时数据推送
- [ ] 集成到 `handleQueryResult()`
  ```typescript
  // 查询结果处理后推送到订阅用户
  async handleQueryResult(data: QueryResultRequest) {
    // 1. 存储结果
    await resultService.saveQueryResult(...);

    // 2. 推送给订阅用户
    socketService.pushToRoom(`${mac}_${pid}`, {
      type: 'queryResult',
      data: result,
      timestamp: Date.now()
    });
  }
  ```

- [ ] 告警实时推送
- [ ] 设备上线/下线通知
- [ ] 批量推送优化（合并多个更新）

#### 2.9.4 WebSocket API
- [ ] `ws://server/ws` - WebSocket 连接端点
- [ ] 认证流程：`auth` 事件 + JWT Token
- [ ] 心跳：`ping/pong` 消息
- [ ] 订阅：`subscribe/unsubscribe` 事件
- [ ] 推送：`data/alarm/status` 消息

#### 2.9.5 测试
- [ ] 单元测试：房间管理逻辑
- [ ] 集成测试：订阅-推送流程
- [ ] 压力测试：1000 并发连接
- [ ] 断线重连测试
- [ ] 内存泄漏测试（24h）

### 验收标准
- ✅ WebSocket 连接稳定（支持 1000+ 并发）
- ✅ JWT 认证正常工作
- ✅ 订阅/推送流程正确
- ✅ 心跳机制防止连接超时
- ✅ 断线自动重连
- ✅ 单元测试覆盖率 > 80%

### 预计工时
- 开发：16-24 小时
- 测试：8-12 小时
- 总计：24-36 小时

---

## 🎯 优先级 3：Phase 2.10 - 集成测试

### 目标
端到端测试完整的实时通信流程，验证系统稳定性和性能指标。

### 任务清单

#### 2.10.1 端到端集成测试
- [ ] Node 客户端连接 → 终端注册 → 查询 → 结果存储
- [ ] Web 客户端订阅 → 实时推送流程
- [ ] DTU 操作 → 执行 → 结果返回
- [ ] 完整的告警流程测试

#### 2.10.2 性能测试
- [ ] 负载测试：1000 终端同时查询
- [ ] 吞吐量测试：测量 queries/second
- [ ] 延迟测试：P50/P95/P99 延迟统计
- [ ] 内存测试：1000 终端的内存使用
- [ ] CPU 测试：查询循环的 CPU 占用

#### 2.10.3 稳定性测试
- [ ] 24 小时耐久测试
- [ ] 内存泄漏检测
- [ ] 连接数压力测试（100+ Node 客户端）
- [ ] 断线重连测试
- [ ] 网络异常恢复测试

#### 2.10.4 生产数据验证
- [ ] 使用真实生产数据测试
- [ ] 对比老系统的查询结果（一致性验证）
- [ ] 性能对比（延迟、吞吐量）
- [ ] 资源占用对比（内存、CPU）

### 验收标准
- ✅ 查询延迟 P95 < 500ms
- ✅ 吞吐量 > 1000 queries/s
- ✅ 内存使用 < 500MB (1000 终端)
- ✅ CPU 使用 < 20%
- ✅ 24 小时运行无崩溃
- ✅ 与老系统结果一致性 > 99.9%

### 预计工时
- 开发：12-16 小时
- 测试：16-24 小时
- 总计：28-40 小时

---

## 📊 Phase 2 总体时间估算

| 阶段 | 预计工时 | 状态 |
|------|---------|------|
| 2.1-2.7 | ~100 小时 | ✅ 已完成 |
| 2.8 DTU 操作 | 12-18 小时 | ⏳ 待开始 |
| 2.9 WebSocket | 24-36 小时 | ⏳ 待开始 |
| 2.10 集成测试 | 28-40 小时 | ⏳ 待开始 |
| **剩余总计** | **64-94 小时** | - |

按每天 8 小时工作，预计需要 **8-12 个工作日** 完成 Phase 2。

---

## 🚀 Phase 3 前瞻

Phase 2 完成后，Phase 3 将聚焦于：

### 3.1 数据处理和告警
- 实时数据解析服务
- 告警规则引擎
- 告警通知（微信、短信、邮件）
- 数据聚合和统计

### 3.2 API 网关
- RESTful API 实现
- GraphQL API（可选）
- API 文档（Swagger）
- 速率限制和权限控制

### 3.3 管理后台
- 设备管理界面
- 用户管理界面
- 实时监控大屏
- 数据可视化

### 3.4 运维和监控
- Prometheus 指标导出
- Grafana 监控面板
- 日志聚合（ELK）
- 告警和通知

---

## 🎯 立即行动项

### 本周目标（Week 1）
1. ✅ **完成 Phase 2.7** - 查询结果处理
2. ⏭️ **启动 Phase 2.8** - DTU 操作实现
   - 创建类型定义
   - 实现操作路由
   - 添加操作日志

### 本周任务分配
- **Day 1-2**: DTU 操作类型和路由实现
- **Day 3**: 操作日志记录
- **Day 4**: DTU 操作 API
- **Day 5**: 单元测试和集成测试

---

## 📝 技术债务清单

### 需要改进的地方
1. **测试覆盖率**
   - 当前：部分单元测试
   - 目标：80% 以上覆盖率
   - 行动：为每个新功能添加测试

2. **错误处理**
   - 当前：基本错误处理
   - 目标：完整的错误分类和恢复
   - 行动：统一错误处理策略

3. **文档**
   - 当前：代码注释和部分文档
   - 目标：完整的 API 文档和架构文档
   - 行动：使用 JSDoc 和 Swagger

4. **性能监控**
   - 当前：基本日志
   - 目标：详细的性能指标
   - 行动：集成 Prometheus

### 优化机会
1. **查询调度算法**
   - 考虑设备优先级
   - 动态调整查询间隔
   - 智能重试策略

2. **缓存策略**
   - Redis 缓存热数据
   - 协议指令缓存优化
   - 查询结果缓存（短期）

3. **数据库优化**
   - 索引优化（已部分完成）
   - 查询优化
   - 分片策略（大规模部署）

---

## 🔗 相关文档

- [Phase 2 总体规划](./PHASE_2_PLAN.md)
- [Phase 2 检查清单](./PHASE_2_CHECKLIST.md)
- [Phase 2.7 完成报告](./PHASE_2.7_COMPLETION_REPORT.md)
- [MongoDB 索引设计](./migration/09-MongoDB索引设计.md)

---

## 📞 联系和协作

如有问题或建议，请通过以下方式联系：
- **Issue 跟踪**: GitHub Issues
- **文档更新**: 直接修改此文档并提交 PR
- **紧急问题**: 联系项目负责人

---

**最后更新**: 2025-12-17
**下次评审**: Phase 2.8 完成后
