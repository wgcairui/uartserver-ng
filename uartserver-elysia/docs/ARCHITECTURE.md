# UartServer Elysia æ¶æ„æ–‡æ¡£

UartServer NG - Elysia.js ç³»ç»Ÿæ¶æ„å®Œæ•´è¯´æ˜

**ç‰ˆæœ¬**: 1.0
**æ—¥æœŸ**: 2025-12-24
**çŠ¶æ€**: Phase 6 - æ–‡æ¡£æ€»ç»“

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è§ˆ](#ç³»ç»Ÿæ¦‚è§ˆ)
2. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
3. [æ¶æ„å±‚æ¬¡](#æ¶æ„å±‚æ¬¡)
4. [æ•°æ®æµ](#æ•°æ®æµ)
5. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
6. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
7. [å®‰å…¨è®¾è®¡](#å®‰å…¨è®¾è®¡)
8. [æ‰©å±•æ€§](#æ‰©å±•æ€§)

---

## ç³»ç»Ÿæ¦‚è§ˆ

### è®¾è®¡ç›®æ ‡

1. **é«˜æ€§èƒ½**: 31k+ req/s ååé‡ï¼Œäºšæ¯«ç§’çº§å“åº”
2. **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œé›¶è¿è¡Œæ—¶ç±»å‹é”™è¯¯
3. **å¯ç»´æŠ¤æ€§**: 100% ä¸šåŠ¡é€»è¾‘å…¼å®¹ï¼Œæ¨¡å—åŒ–æ¶æ„
4. **å®æ—¶é€šä¿¡**: Socket.IO é›†æˆï¼Œæ”¯æŒåŒå‘é€šä¿¡

### æ ¸å¿ƒç‰¹æ€§

- âœ… ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨ï¼ˆEden Treatyï¼‰
- âœ… Zod è¿è¡Œæ—¶éªŒè¯
- âœ… MongoDB + PostgreSQL åŒæ•°æ®åº“
- âœ… Fire-and-Forget å¼‚æ­¥å¤„ç†
- âœ… LRU ç¼“å­˜æœºåˆ¶
- âœ… Socket.IO å®æ—¶é€šä¿¡
- âœ… JWT èº«ä»½éªŒè¯

---

## æŠ€æœ¯æ ˆ

### è¿è¡Œæ—¶ä¸æ¡†æ¶

```
Bun 1.x
  â†“
Elysia.js 1.1.23
  â”œâ”€â”€ @elysiajs/cors        # CORS æ”¯æŒ
  â”œâ”€â”€ @elysiajs/jwt         # JWT éªŒè¯
  â”œâ”€â”€ @elysiajs/static      # é™æ€æ–‡ä»¶æœåŠ¡
  â””â”€â”€ @elysiajs/eden        # å®¢æˆ·ç«¯ç±»å‹å®‰å…¨
```

### æ•°æ®åº“å±‚

```
MongoDB Native Driver 6.x
  â”œâ”€â”€ users (çƒ­æ•°æ®)
  â”œâ”€â”€ terminals (çƒ­æ•°æ®)
  â”œâ”€â”€ protocols (çƒ­æ•°æ®)
  â”œâ”€â”€ alarm.rules (çƒ­æ•°æ®)
  â””â”€â”€ notification.logs (çƒ­æ•°æ®)

PostgreSQL + TypeORM
  â”œâ”€â”€ å†å²æ•°æ®
  â”œâ”€â”€ å½’æ¡£æ—¥å¿—
  â””â”€â”€ å†·æ•°æ®å­˜å‚¨
```

### éªŒè¯ä¸ç±»å‹

```
Zod 3.24.1
  â”œâ”€â”€ è¿è¡Œæ—¶éªŒè¯
  â”œâ”€â”€ ç±»å‹æ¨å¯¼
  â””â”€â”€ é”™è¯¯æ ¼å¼åŒ–

TypeScript 5.x
  â”œâ”€â”€ ä¸¥æ ¼æ¨¡å¼
  â”œâ”€â”€ ç¼–è¯‘æ—¶æ£€æŸ¥
  â””â”€â”€ Eden Treaty ç±»å‹æ¨å¯¼
```

### å®æ—¶é€šä¿¡

```
Socket.IO 4.8.1
  â”œâ”€â”€ @socket.io/bun-engine (Bun é›†æˆ)
  â”œâ”€â”€ æˆ¿é—´ç®¡ç†
  â”œâ”€â”€ äº‹ä»¶å¹¿æ’­
  â””â”€â”€ å‘½åç©ºé—´éš”ç¦»
```

---

## æ¶æ„å±‚æ¬¡

### 1. äº”å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯å±‚ (Client Layer)                     â”‚
â”‚  - Eden Treaty ç±»å‹å®‰å…¨å®¢æˆ·ç«¯                â”‚
â”‚  - Socket.IO Client                          â”‚
â”‚  - React å‰ç«¯åº”ç”¨                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ HTTP/WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è·¯ç”±å±‚ (Route Layer)                        â”‚
â”‚  - Elysia è·¯ç”±å®šä¹‰                           â”‚
â”‚  - å‚æ•°æå–ä¸éªŒè¯                            â”‚
â”‚  - å“åº”æ ¼å¼åŒ–                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœåŠ¡å±‚ (Service Layer)                     â”‚
â”‚  - ä¸šåŠ¡é€»è¾‘å°è£…                              â”‚
â”‚  - æ•°æ®å¤„ç†                                  â”‚
â”‚  - å‘Šè­¦å¼•æ“                                  â”‚
â”‚  - é€šçŸ¥æœåŠ¡                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®è®¿é—®å±‚ (Data Access Layer)              â”‚
â”‚  - MongoDB Collections                       â”‚
â”‚  - PostgreSQL Repositories                   â”‚
â”‚  - ç¼“å­˜ç®¡ç†                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®å­˜å‚¨å±‚ (Storage Layer)                  â”‚
â”‚  - MongoDB æ•°æ®åº“                            â”‚
â”‚  - PostgreSQL æ•°æ®åº“                         â”‚
â”‚  - Redis (å¯é€‰)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ç›®å½•ç»“æ„æ˜ å°„

```
src/
â”œâ”€â”€ routes/              â†’ è·¯ç”±å±‚
â”‚   â”œâ”€â”€ terminal.route.ts
â”‚   â”œâ”€â”€ alarm-rules.route.ts
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ services/            â†’ æœåŠ¡å±‚
â”‚   â”œâ”€â”€ alarm-rule-engine.service.ts
â”‚   â”œâ”€â”€ alarm-notification.service.ts
â”‚   â”œâ”€â”€ data-parsing.service.ts
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ repositories/        â†’ æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ terminal-cache.ts
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ entities/            â†’ æ•°æ®æ¨¡å‹å±‚
â”‚   â”œâ”€â”€ mongodb/
â”‚   â”‚   â”œâ”€â”€ alarm-rule.entity.ts
â”‚   â”‚   â”œâ”€â”€ notification-log.entity.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ typeorm/
â”‚       â”œâ”€â”€ protocol.entity.ts
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ schemas/             â†’ éªŒè¯å±‚
â”‚   â”œâ”€â”€ terminal.schema.ts
â”‚   â”œâ”€â”€ alarm-rules.schema.ts
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ plugins/             â†’ ä¸­é—´ä»¶å±‚
â”‚   â”œâ”€â”€ zod-validator.ts
â”‚   â”œâ”€â”€ error-handler.ts
â”‚   â””â”€â”€ socket-io.ts
â”‚
â””â”€â”€ database/            â†’ æ•°æ®åº“è¿æ¥
    â”œâ”€â”€ mongodb.ts
    â””â”€â”€ postgres.ts
```

---

## æ•°æ®æµ

### 1. HTTP è¯·æ±‚æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â”‚ Eden Treaty â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /api/terminal/queryData
       â”‚ { data: { mac, pid, protocol, ... } }
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Elysia App                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. CORS éªŒè¯                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 2. Zod Validator                   â”‚  â”‚
â”‚  â”‚    - éªŒè¯ body schema              â”‚  â”‚
â”‚  â”‚    - ç±»å‹è½¬æ¢                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 3. Route Handler                   â”‚  â”‚
â”‚  â”‚    - æå–å‚æ•° ({ body })           â”‚  â”‚
â”‚  â”‚    - è°ƒç”¨æœåŠ¡å±‚                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service Layer                            â”‚
â”‚  - æ•°æ®å¤„ç†                               â”‚
â”‚  - ä¸šåŠ¡é€»è¾‘                               â”‚
â”‚  - ç¼“å­˜æ“ä½œ                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Access                              â”‚
â”‚  - MongoDB æŸ¥è¯¢/å†™å…¥                      â”‚
â”‚  - Cache è¯»å†™                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Response                                 â”‚
â”‚  { status: 'ok', data: {...} }            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“ (error handling)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Error Handler Plugin                     â”‚
â”‚  - æ•è·å¼‚å¸¸                               â”‚
â”‚  - æ ¼å¼åŒ–é”™è¯¯                             â”‚
â”‚  - è¿”å›ç»Ÿä¸€é”™è¯¯å“åº”                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. WebSocket è¿æ¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â”‚ Socket.IO   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ws://localhost:3333/socket.io/
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Socket.IO Plugin                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. Bun Engine Handler              â”‚  â”‚
â”‚  â”‚    - WebSocket å‡çº§                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 2. Connection Event                â”‚  â”‚
â”‚  â”‚    - å®¢æˆ·ç«¯è¿æ¥                    â”‚  â”‚
â”‚  â”‚    - åŠ å…¥æˆ¿é—´                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Socket.IO Service                        â”‚
â”‚  - äº‹ä»¶ç›‘å¬                               â”‚
â”‚  - æ¶ˆæ¯å¤„ç†                               â”‚
â”‚  - å¹¿æ’­æ¶ˆæ¯                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Emit to Clients                          â”‚
â”‚  - socket.emit()                          â”‚
â”‚  - io.to(room).emit()                     â”‚
â”‚  - io.emit() (broadcast)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Fire-and-Forget æ¨¡å¼

```
POST /api/terminal/queryData
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Route Handler                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. ç«‹å³è¿”å›å“åº”                    â”‚  â”‚
â”‚  â”‚    return { status: 'ok' }         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 2. setImmediate()                  â”‚  â”‚
â”‚  â”‚    åå°å¼‚æ­¥å¤„ç†                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                      â”‚
       â”‚                      â†“ (background)
       â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚              â”‚  Background Task  â”‚
       â”‚              â”‚  - æ•°æ®è§£æ       â”‚
       â”‚              â”‚  - ç¼“å­˜æ›´æ–°       â”‚
       â”‚              â”‚  - å‘Šè­¦æ£€æµ‹       â”‚
       â†“              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Response   â”‚ 0.12ms âœ¨
â”‚ (immediate) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç»„ä»¶

### 1. Elysia æ’ä»¶ç³»ç»Ÿ

#### Zod Validator (`plugins/zod-validator.ts`)

```typescript
export const zodValidator = () =>
  new Elysia({ name: 'zod-validator' })
    .onError(({ error, set, code }) => {
      if (error instanceof ZodError) {
        set.status = 400;
        return {
          status: 'error',
          message: formatZodError(error),
          errors: formatAllZodErrors(error),
        };
      }
    });
```

**åŠŸèƒ½**:
- æ•è· Zod éªŒè¯é”™è¯¯
- æ ¼å¼åŒ–ä¸ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
- ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼

#### Error Handler (`plugins/error-handler.ts`)

```typescript
export const errorHandler = () =>
  new Elysia({ name: 'error-handler' })
    .onError(({ error, set, code }) => {
      const statusCode = getStatusCode(error);
      set.status = statusCode;

      return {
        status: 'error',
        message: error instanceof Error ? error.message : 'Internal server error',
        code,
      };
    });
```

**åŠŸèƒ½**:
- ç»Ÿä¸€å¼‚å¸¸å¤„ç†
- é”™è¯¯æ—¥å¿—è®°å½•
- ç”Ÿäº§ç¯å¢ƒéšè—æ•æ„Ÿä¿¡æ¯

#### Socket.IO Plugin (`plugins/socket-io.ts`)

```typescript
export const socketIOPlugin = () => {
  const engine = new BunEngine();
  const io = new Server({
    transports: ['polling', 'websocket'],
  });

  io.attachApp(engine);

  return {
    plugin: new Elysia()
      .all('/socket.io/*', ({ request, server }) => {
        if (!server) throw new Error('Server not available');
        return engine.handleRequest(request, server);
      }),
    io,
    engine,
  };
};
```

**åŠŸèƒ½**:
- Bun ä¸ Socket.IO é›†æˆ
- WebSocket å‡çº§å¤„ç†
- å®æ—¶åŒå‘é€šä¿¡

### 2. åŒæ•°æ®åº“ç­–ç•¥

#### MongoDB (çƒ­æ•°æ®)

```typescript
// database/mongodb.ts
export class MongoDB {
  private client: MongoClient;
  private db: Db;

  async connect() {
    this.client = new MongoClient(MONGODB_URI);
    await this.client.connect();
    this.db = this.client.db();
  }

  getDatabase(): Db {
    return this.db;
  }
}

export const mongodb = new MongoDB();
```

**ç”¨é€”**:
- ç”¨æˆ·æ•°æ® (users)
- ç»ˆç«¯è®¾å¤‡ (terminals)
- åè®®é…ç½® (protocols)
- å‘Šè­¦è§„åˆ™ (alarm.rules)
- é€šçŸ¥æ—¥å¿— (notification.logs)

**ä¼˜åŠ¿**:
- çµæ´»çš„ schema
- é«˜æ€§èƒ½è¯»å†™
- æ°´å¹³æ‰©å±•æ€§

#### PostgreSQL (å†·æ•°æ®)

```typescript
// database/postgres.ts
export const AppDataSource = new DataSource({
  type: 'postgres',
  host: POSTGRES_HOST,
  port: POSTGRES_PORT,
  username: POSTGRES_USER,
  password: POSTGRES_PASSWORD,
  database: POSTGRES_DB,
  entities: [/* TypeORM entities */],
  synchronize: false,
});
```

**ç”¨é€”**:
- å†å²æ•°æ®å½’æ¡£
- å®¡è®¡æ—¥å¿—
- åˆ†ææŠ¥è¡¨

**ä¼˜åŠ¿**:
- äº‹åŠ¡æ”¯æŒ
- å¤æ‚æŸ¥è¯¢
- æ•°æ®ä¸€è‡´æ€§

### 3. ç¼“å­˜æœºåˆ¶

#### Terminal Cache (`repositories/terminal-cache.ts`)

```typescript
class TerminalCache {
  private cache = new LRUCache<string, TerminalData>({
    max: 1000,
    ttl: 1000 * 60 * 30, // 30 åˆ†é’Ÿ
  });

  set(mac: string, data: TerminalData): void {
    this.cache.set(mac, data);
    this.stats.hits++;
  }

  get(mac: string): TerminalData | undefined {
    const data = this.cache.get(mac);
    if (data) {
      this.stats.hits++;
    } else {
      this.stats.misses++;
    }
    return data;
  }

  getStats(): CacheStats {
    return {
      total: this.cache.size,
      maxSize: this.cache.max,
      performance: {
        hits: this.stats.hits,
        misses: this.stats.misses,
        hitRate: `${((this.stats.hits / (this.stats.hits + this.stats.misses)) * 100).toFixed(2)}%`,
      },
    };
  }
}
```

**åŠŸèƒ½**:
- LRU æ·˜æ±°ç­–ç•¥
- TTL è¿‡æœŸæœºåˆ¶
- æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡
- å†…å­˜ä¸Šé™æ§åˆ¶

**æ€§èƒ½**:
- ç¼“å­˜å‘½ä¸­ç‡: > 90%
- æŸ¥è¯¢å“åº”æ—¶é—´: < 1ms

### 4. æœåŠ¡å±‚æ¶æ„

#### Alarm Rule Engine (`services/alarm-rule-engine.service.ts`)

```typescript
export class AlarmRuleEngineService {
  private collections: Phase3Collections;

  constructor(db: Db) {
    this.collections = new Phase3Collections(db);
  }

  async addRule(rule: AlarmRuleDocument): Promise<ObjectId> {
    const result = await this.collections.alarmRules.insertOne(rule);
    return result.insertedId;
  }

  async evaluateRules(data: ParsedDataDocument): Promise<AlarmDocument[]> {
    const rules = await this.collections.alarmRules
      .find({ enabled: true, mac: data.mac })
      .toArray();

    const triggeredAlarms: AlarmDocument[] = [];

    for (const rule of rules) {
      if (this.matchesCondition(data, rule)) {
        triggeredAlarms.push(this.createAlarm(rule, data));
      }
    }

    return triggeredAlarms;
  }
}
```

**èŒè´£**:
- è§„åˆ™ç®¡ç† (CRUD)
- è§„åˆ™è¯„ä¼°
- å‘Šè­¦è§¦å‘
- æ¡ä»¶åŒ¹é…

#### Alarm Notification Service (`services/alarm-notification.service.ts`)

```typescript
export class AlarmNotificationService {
  async sendNotification(
    alarm: AlarmDocument,
    channels: NotificationChannel[]
  ): Promise<void> {
    for (const channel of channels) {
      try {
        if (channel === 'wechat') {
          await this.sendWechatNotification(alarm);
        } else if (channel === 'sms') {
          await this.sendSmsNotification(alarm);
        } else if (channel === 'email') {
          await this.sendEmailNotification(alarm);
        }

        await this.logNotification(alarm, channel, 'sent');
      } catch (error) {
        await this.logNotification(alarm, channel, 'failed');
        console.error(`Notification failed for ${channel}:`, error);
      }
    }
  }
}
```

**èŒè´£**:
- å¤šæ¸ é“é€šçŸ¥
- å‘é€æ—¥å¿—è®°å½•
- å¤±è´¥é‡è¯•
- æ¨¡æ¿æ¸²æŸ“

---

## æ€§èƒ½ä¼˜åŒ–

### 1. å“åº”æ—¶é—´ä¼˜åŒ–

#### Fire-and-Forget æ¨¡å¼

```typescript
.post('/queryData', async ({ body }): Promise<QueryDataResponse> => {
  const { data } = body;

  // ç«‹å³è¿”å› (0.12ms)
  setImmediate(() => {
    processDataInBackground(data).catch(console.error);
  });

  return { status: 'ok' };
}, {
  body: QueryDataRequestSchema,
})
```

**æ•ˆæœ**:
- å“åº”æ—¶é—´: **0.12ms** (å¿« 83x)
- ååé‡: **31,130 req/s**

#### LRU ç¼“å­˜

```typescript
const cached = terminalCache.get(mac);
if (cached) {
  return { status: 'ok', data: cached }; // < 1ms
}

const fresh = await fetchFromDatabase(mac); // ~10ms
terminalCache.set(mac, fresh);
return { status: 'ok', data: fresh };
```

**æ•ˆæœ**:
- ç¼“å­˜å‘½ä¸­: **< 1ms**
- ç¼“å­˜æœªå‘½ä¸­: **~10ms**
- å‘½ä¸­ç‡: **> 90%**

### 2. å¹¶å‘æ€§èƒ½

#### Bun åŸç”Ÿä¼˜åŠ¿

```
Elysia + Bun:
  - åŸç”Ÿ WebSocket æ”¯æŒ
  - é›¶æ‹·è´ Buffer å¤„ç†
  - ä¼˜åŒ–çš„ HTTP è§£æå™¨
  - å¹¶è¡Œè¯·æ±‚å¤„ç†
```

**æµ‹è¯•ç»“æœ**:
```
100 å¹¶å‘:  100% æˆåŠŸç‡, å¹³å‡ 0.76ms/req
500 å¹¶å‘:  100% æˆåŠŸç‡, å¹³å‡ 0.08ms/req
```

### 3. å†…å­˜ä¼˜åŒ–

#### LRU ç¼“å­˜é™åˆ¶

```typescript
const cache = new LRUCache({
  max: 1000,        // æœ€å¤š 1000 æ¡
  ttl: 1800000,     // 30 åˆ†é’Ÿè¿‡æœŸ
});
```

**å†…å­˜å ç”¨**:
- Elysia åº”ç”¨: **~28 MB**
- ç¼“å­˜æ•°æ®: **~10 MB**
- æ€»è®¡: **~40 MB**

---

## å®‰å…¨è®¾è®¡

### 1. è¾“å…¥éªŒè¯

#### Zod Schema éªŒè¯

```typescript
export const CreateAlarmRuleRequestSchema = z.object({
  data: z.object({
    name: z.string().min(1).max(100),
    type: z.enum(['threshold', 'constant']),
    level: z.enum(['info', 'warning', 'error', 'critical']),
    // ... æ›´å¤šå­—æ®µ
  }),
});
```

**ä¿æŠ¤**:
- ç±»å‹éªŒè¯
- é•¿åº¦é™åˆ¶
- æšä¸¾çº¦æŸ
- è‡ªå®šä¹‰éªŒè¯è§„åˆ™

### 2. é”™è¯¯å¤„ç†

#### ç”Ÿäº§ç¯å¢ƒéšè—æ•æ„Ÿä¿¡æ¯

```typescript
.onError(({ error, set, code }) => {
  if (process.env.NODE_ENV === 'production') {
    return {
      status: 'error',
      message: 'Internal server error',
      code,
    };
  } else {
    return {
      status: 'error',
      message: error.message,
      stack: error.stack, // ä»…å¼€å‘ç¯å¢ƒ
      code,
    };
  }
})
```

### 3. JWT èº«ä»½éªŒè¯

```typescript
const app = new Elysia()
  .use(jwt({ name: 'jwt', secret: JWT_SECRET }))
  .get('/protected', async ({ jwt, headers }) => {
    const token = headers.authorization?.replace('Bearer ', '');
    const payload = await jwt.verify(token);

    if (!payload) {
      throw new Error('Unauthorized');
    }

    return { status: 'ok', data: payload };
  });
```

---

## æ‰©å±•æ€§

### 1. æ°´å¹³æ‰©å±•

#### æ— çŠ¶æ€è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Instance 1 â”‚    â”‚  Instance 2 â”‚    â”‚  Instance 3 â”‚
â”‚  Elysia App â”‚    â”‚  Elysia App â”‚    â”‚  Elysia App â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚   Load Balancer    â”‚
               â”‚     (Nginx)        â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚   Shared Services  â”‚
               â”‚  - MongoDB         â”‚
               â”‚  - PostgreSQL      â”‚
               â”‚  - Redis (å¯é€‰)    â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ¨¡å—åŒ–è®¾è®¡

#### æ’ä»¶åŒ–è·¯ç”±

```typescript
// ç‹¬ç«‹çš„è·¯ç”±æ¨¡å—
export const terminalRoutes = new Elysia({ prefix: '/api/terminal' })
  .get('/cache/stats', ...)
  .post('/queryData', ...);

export const alarmRulesRoutes = new Elysia({ prefix: '/api/alarm-rules' })
  .get('/', ...)
  .post('/', ...);

// ç»„åˆæ‰€æœ‰è·¯ç”±
const app = new Elysia()
  .use(terminalRoutes)
  .use(alarmRulesRoutes)
  .listen(3333);
```

### 3. æœåŠ¡åˆ†ç¦»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Gateway (Elysia)                     â”‚
â”‚  - è·¯ç”±è½¬å‘                               â”‚
â”‚  - èº«ä»½éªŒè¯                               â”‚
â”‚  - é™æµæ§åˆ¶                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
       â†“       â†“       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Terminalâ”‚ â”‚ Alarm  â”‚ â”‚  User    â”‚
â”‚ Service â”‚ â”‚ Serviceâ”‚ â”‚  Service â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç›‘æ§ä¸æ—¥å¿—

### 1. æ€§èƒ½ç›‘æ§

```typescript
.get('/cache/stats', async (): Promise<CacheStatsResponse> => {
  const stats = terminalCache.getStats();
  return {
    status: 'ok',
    data: {
      total: stats.total,
      performance: {
        hits: stats.hits,
        misses: stats.misses,
        hitRate: stats.hitRate,
      },
    },
  };
})
```

### 2. æ—¥å¿—è®°å½•

```typescript
// ç»“æ„åŒ–æ—¥å¿—
console.log(JSON.stringify({
  timestamp: new Date().toISOString(),
  level: 'info',
  message: 'Data processed',
  mac: data.mac,
  pid: data.pid,
  duration: `${processingTime}ms`,
}));
```

---

## éƒ¨ç½²æ¶æ„

### å¼€å‘ç¯å¢ƒ

```
bun run dev (port 3333)
  â”œâ”€â”€ HMR çƒ­é‡è½½
  â”œâ”€â”€ è¯¦ç»†æ—¥å¿—
  â””â”€â”€ Stack Trace
```

### ç”Ÿäº§ç¯å¢ƒ

```
Docker Container
  â”œâ”€â”€ Bun Runtime
  â”œâ”€â”€ Compiled Binary
  â”œâ”€â”€ Health Check
  â””â”€â”€ Auto Restart
```

---

## æŠ€æœ¯å†³ç­–

### ä¸ºä»€ä¹ˆé€‰æ‹© Elysia.js?

1. **æ€§èƒ½**: 255k req/s åŸºå‡†ï¼Œ3.9x Fastify
2. **ç±»å‹å®‰å…¨**: Eden Treaty ç«¯åˆ°ç«¯ç±»å‹æ¨å¯¼
3. **Bun ç”Ÿæ€**: åŸç”Ÿé›†æˆï¼Œé›¶é…ç½®
4. **å¼€å‘ä½“éªŒ**: é“¾å¼ APIï¼Œç®€æ´è¯­æ³•

### ä¸ºä»€ä¹ˆä¿ç•™ Zod?

1. **è¿è¡Œæ—¶éªŒè¯**: TypeScript ä»…ç¼–è¯‘æ—¶æ£€æŸ¥
2. **é”™è¯¯ä¿¡æ¯**: å‹å¥½çš„é”™è¯¯æç¤º
3. **ç±»å‹æ¨å¯¼**: `z.infer<typeof Schema>`
4. **ç”Ÿæ€æˆç†Ÿ**: å¹¿æ³›ä½¿ç”¨ï¼Œç¨³å®šå¯é 

### ä¸ºä»€ä¹ˆåŒæ•°æ®åº“?

1. **MongoDB**: çƒ­æ•°æ®ï¼Œçµæ´» schemaï¼Œé«˜æ€§èƒ½
2. **PostgreSQL**: å†·æ•°æ®ï¼Œäº‹åŠ¡æ”¯æŒï¼Œå¤æ‚æŸ¥è¯¢
3. **èŒè´£åˆ†ç¦»**: å„å¸å…¶èŒï¼Œä¼˜åŒ–æˆæœ¬

---

## æ€»ç»“

UartServer Elysia æ¶æ„å®ç°äº†:

âœ… **31,130 req/s** ååé‡
âœ… **0.12ms** å¹³å‡å“åº”æ—¶é—´
âœ… **100%** ä¸šåŠ¡é€»è¾‘å…¼å®¹
âœ… **ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨**
âœ… **æ¨¡å—åŒ–å¯æ‰©å±•**

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-12-24
**çŠ¶æ€**: Phase 6 - æ–‡æ¡£æ€»ç»“
